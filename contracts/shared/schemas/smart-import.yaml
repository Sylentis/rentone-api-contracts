# Smart Import schemas for AI-powered vehicle import

# ==================== SESSION SCHEMAS ====================

SmartImportSession:
  type: object
  description: |
    Represents an AI-powered import session. The session goes through states:
    UPLOADING -> PROCESSING -> READY_FOR_REVIEW -> IMPORTING -> COMPLETED/FAILED
  required:
    - id
    - status
    - createdAt
  properties:
    id:
      type: string
      format: uuid
      description: Unique session identifier
      example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
    status:
      $ref: '#/SmartImportStatus'
    fileName:
      type: string
      description: Original uploaded file name
      example: "fleet_vehicles_2024.xlsx"
    fileSize:
      type: integer
      format: int64
      description: File size in bytes
      example: 125000
    totalRows:
      type: integer
      description: Total data rows in file (excluding header)
      example: 50
    mappingSource:
      $ref: '#/MappingSource'
    columnMappings:
      type: array
      items:
        $ref: '#/ColumnMapping'
      description: How file columns map to vehicle fields
    vehicles:
      type: array
      items:
        $ref: '#/VehicleCandidate'
      description: Parsed vehicles ready for review
    validVehiclesCount:
      type: integer
      description: Number of valid vehicles ready to import
      example: 48
    invalidVehiclesCount:
      type: integer
      description: Number of vehicles with validation errors
      example: 2
    importedCount:
      type: integer
      description: Number of successfully imported vehicles (after confirmation)
      example: 48
    errorMessage:
      type: string
      nullable: true
      description: Error message if status is FAILED
      example: "File contains malicious macros"
    createdAt:
      type: string
      format: date-time
      description: When the session was created
      example: "2024-12-15T10:30:00Z"
    expiresAt:
      type: string
      format: date-time
      description: When the session expires (unconfirmed sessions auto-expire)
      example: "2024-12-15T11:30:00Z"
    completedAt:
      type: string
      format: date-time
      nullable: true
      description: When the import was completed

SmartImportStatus:
  type: string
  enum:
    - uploading
    - processing
    - mapping
    - ready_for_review
    - importing
    - completed
    - failed
    - expired
  description: |
    Session status:
    - uploading: File being uploaded
    - processing: Validating file security (macros, injection)
    - mapping: AI is mapping columns to vehicle fields
    - ready_for_review: Vehicles parsed, waiting for user review
    - importing: User confirmed, importing vehicles
    - completed: Import finished successfully
    - failed: Import failed (security issue, validation, etc.)
    - expired: Session expired without confirmation

MappingSource:
  type: string
  enum:
    - ai
    - manual
    - fallback
  description: |
    How column mapping was determined:
    - ai: OpenAI successfully mapped columns
    - manual: User manually mapped columns
    - fallback: Basic column name matching (AI failed)

# ==================== MAPPING SCHEMAS ====================

ColumnMapping:
  type: object
  description: Maps a file column to a vehicle field
  required:
    - fileColumn
    - vehicleField
    - confidence
  properties:
    fileColumn:
      type: string
      description: Column name/header from the file
      example: "Car Brand"
    fileColumnIndex:
      type: integer
      description: Zero-based column index in file
      example: 0
    vehicleField:
      $ref: '#/VehicleField'
    confidence:
      type: number
      format: float
      minimum: 0
      maximum: 1
      description: AI confidence score (1.0 = certain)
      example: 0.95
    sampleValues:
      type: array
      items:
        type: string
      maxItems: 5
      description: Sample values from the file for this column
      example: ["Toyota", "Honda", "BMW", "Mercedes"]

VehicleField:
  type: string
  enum:
    - make
    - model
    - year
    - vehicleType
    - transmission
    - fuelType
    - seats
    - pricePerDay
    - weeklyRate
    - monthlyRate
    - securityDeposit
    - currency
    - vin
    - description
    - features
    - available
    - ignored
  description: |
    Vehicle field to map to. 'ignored' means the column won't be imported.

# ==================== VEHICLE CANDIDATE SCHEMAS ====================

VehicleCandidate:
  type: object
  description: A vehicle parsed from the import file, ready for review
  required:
    - index
    - rowNumber
    - data
    - isValid
  properties:
    index:
      type: integer
      description: Zero-based index in the candidates array
      example: 0
    rowNumber:
      type: integer
      description: Original row number in file (1-based, excluding header)
      example: 1
    data:
      $ref: '#/VehicleCandidateData'
    isValid:
      type: boolean
      description: Whether all required fields are valid
      example: true
    validationErrors:
      type: array
      items:
        $ref: '#/CandidateValidationError'
      description: Validation errors for this vehicle
    isEdited:
      type: boolean
      description: Whether user has edited this vehicle
      default: false
    isSelected:
      type: boolean
      description: Whether this vehicle is selected for import
      default: true

VehicleCandidateData:
  type: object
  description: Parsed vehicle data from file
  properties:
    make:
      type: string
      nullable: true
      example: "Toyota"
    model:
      type: string
      nullable: true
      example: "RAV4"
    year:
      type: integer
      nullable: true
      example: 2023
    vehicleType:
      type: string
      nullable: true
      description: May be raw value from file before validation
      example: "suv"
    transmission:
      type: string
      nullable: true
      example: "automatic"
    fuelType:
      type: string
      nullable: true
      example: "hybrid"
    seats:
      type: integer
      nullable: true
      example: 5
    pricePerDay:
      type: integer
      format: int64
      nullable: true
      description: In smallest currency unit
      example: 25000
    weeklyRate:
      type: integer
      format: int64
      nullable: true
      example: 20000
    monthlyRate:
      type: integer
      format: int64
      nullable: true
      example: 15000
    securityDeposit:
      type: integer
      format: int64
      nullable: true
      example: 50000
    currency:
      type: string
      nullable: true
      example: "PLN"
    vin:
      type: string
      nullable: true
      example: "1HGBH41JXMN109186"
    description:
      type: string
      nullable: true
      example: "Well maintained vehicle"
    features:
      type: array
      items:
        type: string
      nullable: true
      example: ["GPS", "Bluetooth", "Backup Camera"]
    available:
      type: boolean
      nullable: true
      default: true

CandidateValidationError:
  type: object
  required:
    - field
    - message
  properties:
    field:
      type: string
      description: Field name with error
      example: "vehicleType"
    value:
      type: string
      nullable: true
      description: The invalid value
      example: "truck"
    message:
      type: string
      description: Error message
      example: "Invalid vehicle type. Allowed: sedan, suv, compact, van, luxury"

# ==================== REQUEST/RESPONSE SCHEMAS ====================

UploadSmartImportResponse:
  type: object
  required:
    - sessionId
    - status
  properties:
    sessionId:
      type: string
      format: uuid
      description: Session ID to poll for status
      example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
    status:
      $ref: '#/SmartImportStatus'
    message:
      type: string
      example: "File uploaded. Processing will begin shortly."

GetSmartImportSessionResponse:
  type: object
  required:
    - session
  properties:
    session:
      $ref: '#/SmartImportSession'

UpdateColumnMappingsRequest:
  type: object
  description: Manually update column mappings
  required:
    - mappings
  properties:
    mappings:
      type: array
      items:
        $ref: '#/ColumnMappingUpdate'

ColumnMappingUpdate:
  type: object
  required:
    - fileColumnIndex
    - vehicleField
  properties:
    fileColumnIndex:
      type: integer
      description: Index of the file column
      example: 0
    vehicleField:
      $ref: '#/VehicleField'

UpdateColumnMappingsResponse:
  type: object
  required:
    - session
  properties:
    session:
      $ref: '#/SmartImportSession'
    message:
      type: string
      example: "Mappings updated. Vehicles re-parsed."

UpdateVehicleCandidateRequest:
  type: object
  description: Update a specific vehicle candidate
  properties:
    make:
      type: string
      minLength: 1
      maxLength: 100
    model:
      type: string
      minLength: 1
      maxLength: 100
    year:
      type: integer
      minimum: 1900
      maximum: 2100
    vehicleType:
      $ref: 'enums.yaml#/VehicleType'
    transmission:
      $ref: 'enums.yaml#/Transmission'
    fuelType:
      $ref: 'enums.yaml#/FuelType'
    seats:
      type: integer
      minimum: 1
      maximum: 20
    pricePerDay:
      type: integer
      format: int64
      minimum: 0
    weeklyRate:
      type: integer
      format: int64
      minimum: 0
      nullable: true
    monthlyRate:
      type: integer
      format: int64
      minimum: 0
      nullable: true
    securityDeposit:
      type: integer
      format: int64
      minimum: 0
      nullable: true
    currency:
      type: string
      pattern: '^[A-Z]{3}$'
    vin:
      type: string
      maxLength: 17
      nullable: true
    description:
      type: string
      maxLength: 2000
      nullable: true
    features:
      type: array
      items:
        type: string
      maxItems: 20
      nullable: true
    available:
      type: boolean
    isSelected:
      type: boolean
      description: Whether to include this vehicle in import

UpdateVehicleCandidateResponse:
  type: object
  required:
    - vehicle
  properties:
    vehicle:
      $ref: '#/VehicleCandidate'
    message:
      type: string
      example: "Vehicle updated successfully"

ConfirmSmartImportRequest:
  type: object
  description: Confirm and start the import
  properties:
    selectedIndices:
      type: array
      items:
        type: integer
      description: |
        Optional list of vehicle indices to import.
        If not provided, all valid and selected vehicles will be imported.
      example: [0, 1, 3, 4]

ConfirmSmartImportResponse:
  type: object
  required:
    - session
  properties:
    session:
      $ref: '#/SmartImportSession'
    importedVehicleIds:
      type: array
      items:
        $ref: 'common.yaml#/VehicleId'
      description: IDs of successfully imported vehicles
    message:
      type: string
      example: "Import completed. 48 vehicles imported."

CancelSmartImportResponse:
  type: object
  properties:
    message:
      type: string
      example: "Import session cancelled"

# ==================== ERROR SCHEMAS ====================

SmartImportSecurityError:
  type: object
  description: Security violation during file processing
  required:
    - error
    - errorCode
    - message
  properties:
    error:
      type: string
      example: "Security Violation"
    errorCode:
      type: string
      enum:
        - MALICIOUS_MACRO
        - CSV_INJECTION
        - INVALID_FILE_TYPE
        - FILE_TOO_LARGE
        - CORRUPTED_FILE
      example: "CSV_INJECTION"
    message:
      type: string
      example: "File contains potentially malicious formula injection"
    details:
      type: string
      nullable: true
      description: Additional details (sanitized for security)
    timestamp:
      type: string
      format: date-time
